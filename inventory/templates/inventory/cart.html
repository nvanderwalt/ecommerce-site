{% extends "base.html" %}
{% load static %}

{% block title %}Shopping Cart - FitFusion{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'inventory/cart.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="cart-card">
                <div class="cart-header">
                    <div class="brand-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h1 class="cart-title">Your Shopping Cart</h1>
                    <p class="cart-subtitle">Review your fitness journey items</p>
                </div>
                
                {% if cart_items %}
                    <div class="cart-content">
                        <div class="cart-items">
                            {% for item in cart_items %}
                                <div class="cart-item">
                                    <div class="item-main">
                                        <div class="item-icon">
                                            {% if item.item_type == 'product' %}
                                                <i class="fas fa-dumbbell"></i>
                                            {% else %}
                                                <i class="fas fa-running"></i>
                                            {% endif %}
                                        </div>
                                        <div class="item-details">
                                            <h5 class="item-name">{{ item.item.name }}</h5>
                                            <p class="item-type">
                                                <span class="type-badge">
                                                    {% if item.item_type == 'plan' %}
                                                        Exercise Plan
                                                    {% elif item.item_type == 'nutrition_plan' %}
                                                        Nutrition Plan
                                                    {% elif item.item_type == 'subscription_plan' %}
                                                        Subscription Plan
                                                    {% else %}
                                                        {{ item.item_type|title }}
                                                    {% endif %}
                                                </span>
                                            </p>
                                            <p class="item-price">€{{ item.item.price }}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="item-controls">
                                        <div class="quantity-controls">
                                            <form method="POST" action="{% url 'inventory:update_cart' item.item_type item.item.id %}" class="quantity-form">
                                                {% csrf_token %}
                                                <button type="submit" name="action" value="decrease" class="quantity-btn">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <span class="quantity-display">{{ item.quantity }}</span>
                                                {% if item.item_type in 'exercise_plan,plan,nutrition_plan,subscription_plan' %}
                                                    <button type="submit" name="action" value="increase" class="quantity-btn" disabled title="You can only order one of each plan">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                {% else %}
                                                    <button type="submit" name="action" value="increase" class="quantity-btn">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                {% endif %}
                                            </form>
                                        </div>
                                        
                                        <p class="item-subtotal">€{{ item.item_total }}</p>
                                        
                                        <form method="POST" action="{% url 'inventory:remove_from_cart' item.item_type item.item.id %}" class="remove-form">
                                            {% csrf_token %}
                                            <button type="submit" class="remove-btn">
                                                <i class="fas fa-trash"></i>
                                                <span>Remove</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="order-summary">
                            <div class="summary-header">
                                <i class="fas fa-receipt"></i>
                                <h5>Order Summary</h5>
                            </div>
                            <div class="summary-content">
                                <div class="summary-row">
                                    <span>Items ({{ cart_items|length }}):</span>
                                    <span class="summary-value">€{{ total }}</span>
                                </div>
                                <div class="summary-divider"></div>
                                <div class="summary-row total">
                                    <span>Total:</span>
                                    <span class="summary-total">€{{ total }}</span>
                                </div>
                                
                                <form id="payment-form" class="checkout-form">
                                    {% csrf_token %}
                                    <button type="button" id="checkout-button" class="checkout-btn">
                                        <i class="fas fa-credit-card"></i>
                                        <span>Proceed to Checkout</span>
                                    </button>
                                </form>
                                
                                <div class="security-note">
                                    <i class="fas fa-lock"></i>
                                    <span>Secure payment powered by Stripe</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="cart-actions">
                            <a href="{% url 'inventory:product_list' %}" class="action-btn secondary">
                                <i class="fas fa-arrow-left"></i>
                                <span>Continue Shopping</span>
                            </a>
                            <a href="{% url 'exercise_plan_list' %}" class="action-btn secondary">
                                <i class="fas fa-running"></i>
                                <span>Browse Exercise Plans</span>
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-cart">
                        <div class="empty-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3 class="empty-title">Your cart is empty</h3>
                        <p class="empty-subtitle">Start your fitness journey by adding some products or exercise plans to your cart!</p>
                        <div class="empty-actions">
                            <a href="{% url 'inventory:product_list' %}" class="action-btn primary">
                                <i class="fas fa-shopping-bag"></i>
                                <span>Browse Products</span>
                            </a>
                            <a href="{% url 'exercise_plan_list' %}" class="action-btn secondary">
                                <i class="fas fa-running"></i>
                                <span>View Exercise Plans</span>
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if cart_items %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ stripe_public_key }}");

    document.getElementById("checkout-button").addEventListener("click", function () {
        const button = this;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Processing...</span>';
        
        fetch("{% url 'create_checkout_session' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(session => {
            if (session.error) {
                throw new Error(session.error);
            }
            return stripe.redirectToCheckout({ sessionId: session.id });
        })
        .catch(error => {
            console.error('Error:', error);
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-credit-card"></i><span>Proceed to Checkout</span>';
            alert('An error occurred during checkout. Please try again.');
        });
    });
</script>
{% endif %}
{% endblock %}
